function e(e){for(var t=new n(e.size),a=0;a<e.size;++a)for(var i=0;i<e.size;++i)tile=e.grid.cells[a][i],t.grid.cells[a][i]=tile?r(tile):null;return t}function r(e){return new Tile({x:e.x,y:e.y},e.value)}function n(r){var n=this;function t(e){for(var r=0,t=0;t<n.size;t++)for(var a=null,i=0;i<n.size;i++){var o=n.grid.cells,l=e?o[t][i]:o[i][t],s=l?l.value:null;a&&a==s?(r+=Math.log(s)/Math.log(2)*.1,a=null):a=s}return r}buildTraversals=function(e){for(var r={x:[],y:[]},t=0;t<n.size;t++)r.x.push(t),r.y.push(t);return 1===e.x&&(r.x=r.x.reverse()),1===e.y&&(r.y=r.y.reverse()),r},n.print=function(){for(var e=0;e<n.size;++e){row="";for(var r=0;r<n.size;++r)tile=n.grid.cells[r][e],row+=" "+(tile?tile.value:".");console.log(row)}},n.move=function(e){var r,t,a=function(e){return{0:{x:0,y:-1},1:{x:1,y:0},2:{x:0,y:1},3:{x:-1,y:0}}[e]}(e),i=buildTraversals(a),o=!1;return n.grid.eachCell((function(e,r,n){n&&(n.mergedFrom=null,n.savePosition())})),i.x.forEach((function(e){i.y.forEach((function(i){if(r={x:e,y:i},t=n.grid.cellContent(r)){var l=function(e,r){var t;do{e={x:(t=e).x+r.x,y:t.y+r.y}}while(n.grid.withinBounds(e)&&n.grid.cellAvailable(e));return{farthest:t,next:e}}(r,a),s=n.grid.cellContent(l.next);if(s&&s.value===t.value&&!s.mergedFrom){var u=new Tile(l.next,2*t.value);u.mergedFrom=[t,s],n.grid.insertTile(u),n.grid.removeTile(t),t.updatePosition(l.next),2048===u.value&&(n.won=!0)}else!function(e,r){n.grid.cells[e.x][e.y]=null,n.grid.cells[r.x][r.y]=e,e.updatePosition(r)}(t,l.farthest);((c=r).x!==(v=t).x||c.y!==v.y)&&(o=!0)}var c,v}))})),o},n.possibleMoves=function(){for(var r=[],t=(r.length,0);t<4;++t){var a=e(n);a.move(t)&&(a.byDirection=t,r.push(a))}return r},n.possibleChallenges=function(){for(var r=[],t=(r.length,n.grid.availableCells()),a=2;a<=4;a*=2)for(var i=0;i<t.length;++i){var o=e(n),l=new Tile(t[i],a);o.grid.insertTile(l),o.byTile=l,r.push(o)}return r},n.score=function(e){if(e<=0)return 0;for(var r=n.possibleChallenges(),a=0,i=0,o=0;o<r.length;o++)r[o].dead()&&i++,a+=r[o].score(e-1);r.length;var l=.7*(t(!0)+t(!1)),s=state.grid.availableCells().length;return s+a/s/100+l},n.dead=function(){return 0==n.grid.availableCells()&&0==n.possibleMoves().length},n.moveScore=function(){for(var e=[0,0,0,0],r=n.possibleMoves(),t=0;t<r.length;t++){var a=r[t];e[a.byDirection]=a.score(2)}return e},n.bestMove=function(){var e=n.moveScore(),r=0,t=0;for(var a in e)e[a]>r&&(t=a,r=e[a]);return t},n.grid=new Grid(r),n.size=r}function t(){for(var e=document.getElementsByClassName("grid-row").length,r=document.getElementsByClassName("tile"),t=new n(e),a=0;a<r.length;++a){var i=r[a].getAttribute("class").match("tile-(\\d+).+tile-position-(\\d+)-(\\d+)");i&&t.grid.insertTile(new Tile({x:i[2]-1,y:i[3]-1},i[1]))}return t}var a;(a=document.getElementById("#resolver"))||(a=document.createElement("div"),container=document.getElementsByClassName("game-container")[0],container.parentElement.insertBefore(a,container)),a.innerHTML='<div id="hint"><a href="javascript:run();">Run</a> | <a href="javascript:autoMove();">Next</a> | <a href="javascript:stop();">Stop</a></div>',window.state=t(),state.print(),console.log("game=",window.game),window.game||(console.log("reload game"),window.LocalScoreManager?window.game=new GameManager(5,KeyboardInputManager,HTMLActuator,LocalScoreManager):window.game=new GameManager(4,KeyboardInputManager,HTMLActuator,LocalStorageManager));
